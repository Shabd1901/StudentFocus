{% extends "base.html" %}

{% block title %}Planner - Student Productivity Hub{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">
        <i class="fas fa-calendar-alt text-primary me-2"></i>
        Study Planner
    </h1>
    <button class="btn btn-primary" onclick="addNewTask()">
        <i class="fas fa-plus me-1"></i>
        Add Task
    </button>
</div>

<div class="row">
    <div class="col-lg-8">
        <!-- Quick Add Task -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">Quick Add Task</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="taskTitle" class="form-label">Task Title</label>
                        <input type="text" class="form-control" id="taskTitle" placeholder="Enter task title...">
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="taskDue" class="form-label">Due Date</label>
                        <input type="date" class="form-control" id="taskDue">
                    </div>
                </div>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="taskPriority" class="form-label">Priority</label>
                        <select class="form-select" id="taskPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="taskCategory" class="form-label">Category</label>
                        <div class="input-group">
                            <select class="form-select" id="taskCategory">
                                <option value="assignment">Assignment</option>
                                <option value="exam">Exam</option>
                                <option value="project">Project</option>
                                <option value="reading">Reading</option>
                                <option value="other">Other</option>
                            </select>
                            <button class="btn btn-outline-secondary" type="button" onclick="showAddCategory()">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="mb-3">
                    <label for="taskDescription" class="form-label">Description (Optional)</label>
                    <textarea class="form-control" id="taskDescription" rows="2" placeholder="Task details..."></textarea>
                </div>
                <button class="btn btn-primary" onclick="saveTask()">
                    <i class="fas fa-save me-1"></i>
                    Add Task
                </button>
            </div>
        </div>
        
        <!-- Tasks List -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h6 class="card-title mb-0">Your Tasks</h6>
                <div class="btn-group btn-group-sm" role="group">
                    <input type="radio" class="btn-check" name="taskFilter" id="filterAll" autocomplete="off" checked>
                    <label class="btn btn-outline-primary" for="filterAll">All</label>
                    
                    <input type="radio" class="btn-check" name="taskFilter" id="filterPending" autocomplete="off">
                    <label class="btn btn-outline-primary" for="filterPending">Pending</label>
                    
                    <input type="radio" class="btn-check" name="taskFilter" id="filterCompleted" autocomplete="off">
                    <label class="btn btn-outline-primary" for="filterCompleted">Completed</label>
                </div>
            </div>
            <div class="card-body" id="tasksList">
                <div class="text-center text-muted py-4">
                    <i class="fas fa-tasks fa-3x mb-3"></i>
                    <p>No tasks yet. Add your first task above!</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="col-lg-4">
        <!-- Today's Overview -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Today's Overview</h6>
            </div>
            <div class="card-body">
                <div id="todayStats">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0 text-primary" id="pendingCount">0</div>
                                <small class="text-muted">Pending</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="border rounded p-2">
                                <div class="h4 mb-0 text-success" id="completedCount">0</div>
                                <small class="text-muted">Completed</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Productivity Tips -->
        <div class="card mb-3">
            <div class="card-header">
                <h6 class="card-title mb-0">Productivity Tips</h6>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-clock me-2"></i>
                    <strong>Pomodoro Technique:</strong> Work for 25 minutes, then take a 5-minute break.
                </div>
                
                <h6>Study Strategies:</h6>
                <ul class="list-unstyled">
                    <li><i class="fas fa-star text-warning me-2"></i>Prioritize high-impact tasks</li>
                    <li><i class="fas fa-star text-warning me-2"></i>Break large projects into smaller steps</li>
                    <li><i class="fas fa-star text-warning me-2"></i>Set realistic deadlines</li>
                    <li><i class="fas fa-star text-warning me-2"></i>Reward yourself for completion</li>
                </ul>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">Quick Actions</h6>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary btn-sm" onclick="clearCompleted()">
                        <i class="fas fa-broom me-1"></i>
                        Clear Completed
                    </button>
                    <button class="btn btn-outline-warning btn-sm" onclick="celebrateProgress()">
                        <i class="fas fa-trophy me-1"></i>
                        Celebrate Progress
                    </button>
                    <button class="btn btn-outline-info btn-sm" onclick="manageCategories()">
                        <i class="fas fa-tags me-1"></i>
                        Manage Categories
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Task management functionality
let tasks = JSON.parse(localStorage.getItem('studentTasks') || '[]');
let categories = JSON.parse(localStorage.getItem('taskCategories') || '["assignment", "exam", "project", "reading", "other"]');
let editingTaskId = null;

document.addEventListener('DOMContentLoaded', function() {
    // Set today's date as default
    document.getElementById('taskDue').value = new Date().toISOString().split('T')[0];
    
    loadCategories();
    displayTasks();
    updateStats();
    
    // Filter event listeners
    document.querySelectorAll('input[name="taskFilter"]').forEach(radio => {
        radio.addEventListener('change', displayTasks);
    });
});

function addNewTask() {
    document.getElementById('taskTitle').value = '';
    document.getElementById('taskDescription').value = '';
    document.getElementById('taskDue').value = new Date().toISOString().split('T')[0];
    document.getElementById('taskPriority').value = 'medium';
    document.getElementById('taskCategory').value = 'assignment';
    document.getElementById('taskTitle').focus();
}

function saveTask() {
    const title = document.getElementById('taskTitle').value.trim();
    const due = document.getElementById('taskDue').value;
    const priority = document.getElementById('taskPriority').value;
    const category = document.getElementById('taskCategory').value;
    const description = document.getElementById('taskDescription').value.trim();
    
    if (!title) {
        alert('Please enter a task title.');
        return;
    }
    
    const task = {
        id: Date.now(),
        title: title,
        due: due,
        priority: priority,
        category: category,
        description: description,
        completed: false,
        createdAt: new Date().toISOString()
    };
    
    tasks.unshift(task);
    localStorage.setItem('studentTasks', JSON.stringify(tasks));
    
    // Show success message
    showSuccessMessage('Task added successfully!');
    
    // Clear form
    addNewTask();
    
    // Refresh display
    displayTasks();
    updateStats();
    
    // Celebrate!
    celebrateProgress();
}

function displayTasks() {
    const container = document.getElementById('tasksList');
    const filter = document.querySelector('input[name="taskFilter"]:checked').id;
    
    let filteredTasks = tasks;
    if (filter === 'filterPending') {
        filteredTasks = tasks.filter(task => !task.completed);
    } else if (filter === 'filterCompleted') {
        filteredTasks = tasks.filter(task => task.completed);
    }
    
    if (filteredTasks.length === 0) {
        container.innerHTML = `
            <div class="text-center text-muted py-4">
                <i class="fas fa-tasks fa-3x mb-3"></i>
                <p>No tasks in this category. ${filter === 'filterAll' ? 'Add your first task above!' : ''}</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = filteredTasks.map(task => {
        const priorityClass = {
            high: 'danger',
            medium: 'warning',
            low: 'success'
        }[task.priority];
        
        const isOverdue = new Date(task.due) < new Date() && !task.completed;
        
        return `
            <div class="border rounded p-3 mb-3 ${task.completed ? 'bg-light bg-opacity-10' : ''}">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" ${task.completed ? 'checked' : ''} 
                               onchange="toggleTask(${task.id})">
                        <label class="form-check-label ${task.completed ? 'text-decoration-line-through text-muted' : ''}">
                            <strong>${task.title}</strong>
                        </label>
                    </div>
                    <div class="d-flex gap-1">
                        <span class="badge bg-${priorityClass}">${task.priority}</span>
                        <span class="badge bg-secondary">${task.category}</span>
                    </div>
                </div>
                
                ${task.description ? `<p class="text-muted small mb-2">${task.description}</p>` : ''}
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        <i class="fas fa-calendar me-1"></i>
                        Due: ${new Date(task.due).toLocaleDateString()}
                        ${isOverdue ? '<span class="text-danger ms-2"><i class="fas fa-exclamation-triangle"></i> Overdue</span>' : ''}
                    </small>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-primary" onclick="editTask(${task.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteTask(${task.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function toggleTask(id) {
    const task = tasks.find(t => t.id === id);
    if (task) {
        task.completed = !task.completed;
        localStorage.setItem('studentTasks', JSON.stringify(tasks));
        displayTasks();
        updateStats();
        
        if (task.completed) {
            celebrateProgress();
            showSuccessMessage('Great job! Task completed!');
        }
    }
}

function deleteTask(id) {
    if (confirm('Are you sure you want to delete this task?')) {
        tasks = tasks.filter(t => t.id !== id);
        localStorage.setItem('studentTasks', JSON.stringify(tasks));
        displayTasks();
        updateStats();
        showSuccessMessage('Task deleted successfully!');
    }
}

function clearCompleted() {
    const completedCount = tasks.filter(t => t.completed).length;
    if (completedCount === 0) {
        alert('No completed tasks to clear!');
        return;
    }
    
    if (confirm(`Are you sure you want to clear ${completedCount} completed task(s)?`)) {
        tasks = tasks.filter(t => !t.completed);
        localStorage.setItem('studentTasks', JSON.stringify(tasks));
        displayTasks();
        updateStats();
        showSuccessMessage('Completed tasks cleared!');
    }
}

function updateStats() {
    const pending = tasks.filter(t => !t.completed).length;
    const completed = tasks.filter(t => t.completed).length;
    
    document.getElementById('pendingCount').textContent = pending;
    document.getElementById('completedCount').textContent = completed;
}

function loadCategories() {
    const select = document.getElementById('taskCategory');
    select.innerHTML = '';
    
    categories.forEach(category => {
        const option = document.createElement('option');
        option.value = category;
        option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
        select.appendChild(option);
    });
}

function showAddCategory() {
    const categoryName = prompt('Enter new category name:');
    if (categoryName && categoryName.trim()) {
        const newCategory = categoryName.trim().toLowerCase();
        if (!categories.includes(newCategory)) {
            categories.push(newCategory);
            localStorage.setItem('taskCategories', JSON.stringify(categories));
            loadCategories();
            document.getElementById('taskCategory').value = newCategory;
        }
    }
}

function manageCategories() {
    const categoryList = categories.map((cat, index) => `${index + 1}. ${cat}`).join('\n');
    const message = `Current categories:\n${categoryList}\n\nEnter the number of the category to delete, or 'add' to add a new one:`;
    const action = prompt(message);
    
    if (action === 'add') {
        showAddCategory();
    } else {
        const index = parseInt(action) - 1;
        if (index >= 0 && index < categories.length) {
            const categoryToDelete = categories[index];
            if (confirm(`Delete category "${categoryToDelete}"? This won't affect existing tasks.`)) {
                categories.splice(index, 1);
                localStorage.setItem('taskCategories', JSON.stringify(categories));
                loadCategories();
            }
        }
    }
}

function editTask(id) {
    editingTaskId = id;
    const task = tasks.find(t => t.id === id);
    if (task) {
        document.getElementById('taskTitle').value = task.title;
        document.getElementById('taskDue').value = task.due;
        document.getElementById('taskPriority').value = task.priority;
        document.getElementById('taskCategory').value = task.category;
        document.getElementById('taskDescription').value = task.description;
        
        // Change button text
        const addBtn = document.querySelector('button[onclick="saveTask()"]');
        addBtn.innerHTML = '<i class="fas fa-save me-1"></i>Update Task';
        addBtn.onclick = updateTask;
    }
}

function updateTask() {
    const task = tasks.find(t => t.id === editingTaskId);
    if (task) {
        const title = document.getElementById('taskTitle').value.trim();
        if (!title) {
            alert('Please enter a task title.');
            return;
        }
        
        task.title = title;
        task.due = document.getElementById('taskDue').value;
        task.priority = document.getElementById('taskPriority').value;
        task.category = document.getElementById('taskCategory').value;
        task.description = document.getElementById('taskDescription').value.trim();
        
        localStorage.setItem('studentTasks', JSON.stringify(tasks));
        
        showSuccessMessage('Task updated successfully!');
        addNewTask(); // Reset form
        displayTasks();
        updateStats();
        
        // Reset button
        const addBtn = document.querySelector('button[onclick="updateTask()"]');
        addBtn.innerHTML = '<i class="fas fa-save me-1"></i>Add Task';
        addBtn.onclick = saveTask;
        editingTaskId = null;
    }
}

function showSuccessMessage(message) {
    const alert = document.createElement('div');
    alert.className = 'alert alert-success alert-dismissible fade show mt-3';
    alert.innerHTML = `
        <i class="fas fa-check-circle me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.querySelector('.card-body').appendChild(alert);
    
    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 3000);
}
</script>
{% endblock %}
